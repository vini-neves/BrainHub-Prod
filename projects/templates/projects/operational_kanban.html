{# projects/templates/projects/operacional_kanban.html #}
{% extends "projects/base.html" %}
{% load static %}


{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/operacional_kanban.css' %}">
{% endblock %}

{% block content %}
<div class="kanban-wrapper">

    <div class="kanban-header d-flex justify-content-between align-items-center">
        <div>
            <h4 class="m-0 fw-bold text-dark">{{ page_title }}</h4>
            <span class="text-muted small">Fluxo de Produção Social Media</span>
        </div>

        <div class="d-flex gap-2">
            <div class="btn-group">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="fa-solid fa-filter"></i> Filtrar
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#">Minhas Tarefas</a></li>
                    <li><a class="dropdown-item" href="#">Alta Prioridade</a></li>
                </ul>
            </div>
        </div>
    </div>

    <div class="kanban-board" id="kanban-board">
        
        {% for column in kanban_columns %}
        <div class="col-kanban">
            
            <div class="col-kanban-header">
                <div class="d-flex align-items-center">
                    <span class="col-dot dot-{{ column.id }}"></span>
                    <span>{{ column.title }}</span>
                </div>
                <span class="badge bg-light text-secondary border rounded-pill">{{ column.tasks|length }}</span>
            </div>
            
            <div class="kanban-tasks-list" id="col-{{ column.id }}" data-status="{{ column.id }}">
                
                {% if column.id == 'briefing' %}
                    <button class="btn-add-ghost" onclick="openNewTaskModal()">
                        <i class="fa-solid fa-plus me-2"></i> Novo Post
                    </button>
                {% endif %}
                
                {% for task in column.tasks %}
                <div class="kanban-card"
                     draggable="true"
                     data-id="{{ task.id }}"
                     onclick="openEditModal({{ task.id }})">
                    
                    {% if task.art_url and column.id != 'briefing' and column.id != 'copy' %}
                        <img src="{{ task.art_url }}" class="card-cover" alt="Arte">
                    {% endif %}
                    
                    <div class="p-3">
                        <h6 class="fw-bold text-dark mb-2" style="font-size: 0.9rem; line-height: 1.4;">
                            {{ task.title }}
                        </h6>
                        
                        {% if not task.art_url or column.id == 'briefing' or column.id == 'copy' %}
                            <p class="text-muted small mb-3" style="font-size: 0.8rem; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">
                                {{ task.description|default:task.briefing_text|default:"Sem descrição..." }}
                            </p>
                        {% endif %}

                        <div class="d-flex justify-content-between align-items-center mt-2 pt-2 border-top border-light">
                            
                            <div class="text-muted x-small d-flex align-items-center" style="font-size: 0.7rem;">
                                <i class="fa-regular fa-calendar me-1"></i> 
                                {% if task.scheduled_date %}
                                    {{ task.scheduled_date|slice:"8:10" }}/{{ task.scheduled_date|slice:"5:7" }}
                                {% else %}
                                    --
                                {% endif %}
                                
                                <i class="fa-regular fa-clock ms-2 me-1"></i>
                                --:--
                            </div>

                            <div class="d-flex align-items-center gap-2">
                                {% if task.social_network %}
                                    {% if task.social_network == 'instagram' %}<i class="fa-brands fa-instagram text-danger"></i>
                                    {% elif task.social_network == 'facebook' %}<i class="fa-brands fa-facebook text-primary"></i>
                                    {% elif task.social_network == 'linkedin' %}<i class="fa-brands fa-linkedin text-info"></i>
                                    {% else %}<i class="fa-solid fa-share-nodes text-secondary"></i>{% endif %}
                                {% endif %}
                            </div>

                        </div>
                        
                        <div class="mt-2 d-flex align-items-center">
                            
                            {% if task.client_logo %}
                                <img src="{{ task.client_logo }}" class="client-avatar-small" alt="{{ task.client_name }}" style="object-fit: cover; background: white;">
                            {% else %}
                                <div class="client-avatar-small">
                                    {{ task.client_name|slice:":2"|upper }}
                                </div>
                            {% endif %}
                            
                            <span class="text-muted small text-truncate" style="font-size: 0.75rem; max-width: 120px;">
                                {{ task.client_name }}
                            </span>
                        </div>

                    </div>
                </div>
                {% empty %}
                    {% if column.id != 'briefing' %} <div class="text-center text-muted small py-4 opacity-50">Vazio</div>
                    {% endif %}
                {% endfor %}

            </div>
        </div>
        {% endfor %}
        
    </div>
</div>
{% endblock %}


{% block modals %}

<div class="modal fade" id="taskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-dialog-clean">
        <div class="modal-content modal-content-clean">
            
            <div class="modal-header modal-header-clean justify-content-between">
                <div class="modal-title-custom">
                    <span style="width: 10px; height: 10px; background-color: #6f42c1; border-radius: 50%; display: inline-block;"></span>
                    Briefing
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <ul class="nav d-none" id="taskTabs">
                <li class="nav-item"><button data-bs-target="#tab-briefing" data-bs-toggle="tab"></button></li>
                <li class="nav-item"><button data-bs-target="#tab-copy" data-bs-toggle="tab"></button></li>
                <li class="nav-item"><button data-bs-target="#tab-design" data-bs-toggle="tab"></button></li>
                <li class="nav-item"><button data-bs-target="#tab-approval" data-bs-toggle="tab"></button></li>
            </ul>

            <div class="modal-body pt-4">
                <form id="kanbanTaskForm" method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="task_id" id="task-id">
                    <input type="hidden" name="kanban_type" value="operational">
                    
                    <div class="tab-content">
                        
                        <div class="tab-pane fade show active" id="tab-briefing">
                            <div class="row g-3">
                                <div class="col-12 mb-2">
                                    <label class="modal-briefing-label text-muted small">Cliente</label>
                                    <select name="client" id="clientSelect" class="form-select form-select-clean border-0 bg-light fw-bold" required>
                                        <option value="">Selecione o Cliente...</option>
                                        {% for client in clients %}
                                            <option value="{{ client.id }}">{{ client.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="modal-briefing-label">Título do Post</label>
                                    <input type="text" name="title" id="modalTitleInput" class="form-control form-control-clean bg-light" placeholder="Ex: Campanha Black Friday" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="modal-briefing-label">Rede Social</label>
                                    <select name="social_network" id="networkSelect" class="form-select form-select-clean">
                                        <option value="">Instagram</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="modal-briefing-label">Tipo de Conteúdo</label>
                                    <select name="content_type" id="formatSelect" class="form-select form-select-clean">
                                        <option value="">Reels</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="modal-briefing-label">Data de Agendamento</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-end-0 border-secondary-subtle"><i class="fa-regular fa-calendar"></i></span>
                                        <input type="date" name="scheduled_date" id="scheduled_date" class="form-control form-control-clean border-start-0 ps-0">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="modal-briefing-label">Horário</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-end-0 border-secondary-subtle"><i class="fa-regular fa-clock"></i></span>
                                        <input type="time" name="scheduled_time" class="form-control form-control-clean border-start-0 ps-0">
                                    </div>
                                </div>
                                <div class="col-12 mt-3">
                                    <label class="modal-briefing-label">Briefing</label>
                                    <textarea name="briefing_text" id="briefing_text" class="form-control form-control-clean bg-light" rows="5" placeholder="Descreva o objetivo do post..."></textarea>
                                </div>
                                <div class="col-12 mt-4">
                                    <label class="modal-briefing-label">Mídia de Referência</label>
                                    <div class="upload-box-dashed position-relative" style="border: 2px dashed #a0aec0; border-radius: 10px;">
                                        <input type="file" name="briefing_files" class="position-absolute w-100 h-100 top-0 start-0 opacity-0" style="cursor: pointer;" onchange="updateFileName(this)">
                                        <div class="py-4">
                                            <i class="fa-solid fa-arrow-up-from-bracket fs-3 text-secondary mb-2"></i>
                                            <p class="mb-0 fw-bold text-secondary" id="uploadTextMain">Arraste arquivos ou clique para fazer upload</p>
                                            <small class="text-muted">PNG, JPG, MP4 até 50MB</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-end gap-2 mt-4 pt-2">
                                <button type="button" class="btn btn-outline-secondary px-4 fw-bold" data-bs-dismiss="modal" style="border-radius: 8px;">Cancelar</button>
                                <button type="button" class="btn btn-success px-4 fw-bold text-white" style="background-color: #00bfa5; border: none; border-radius: 8px;" onclick="saveAndAdvance('copy')">Enviar para Copy</button>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="tab-copy">
                             <h5 class="fw-bold mb-3 text-primary">Copywriting e Roteiro</h5>
                             
                             <div class="mb-3">
                                <label class="modal-briefing-label">Legenda do Post</label>
                                <textarea name="caption_content" id="inputCaption" class="form-control form-control-clean" rows="4" placeholder="Escreva a legenda aqui..."></textarea>
                             </div>

                             <div class="mb-3">
                                <label class="modal-briefing-label">Roteiro / Texto na Arte</label>
                                <textarea name="script_content" id="script_content" class="form-control form-control-clean" rows="4" placeholder="Roteiro de vídeo ou texto que vai na imagem..."></textarea>
                             </div>

                             <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-outline-secondary" onclick="goToTab('tab-briefing')">Voltar</button>
                                <button type="button" class="btn btn-primary" onclick="saveAndAdvance('design')">Salvar e Enviar para Design</button>
                             </div>
                        </div>
                        
                        <div class="tab-pane fade" id="tab-design">
                             <div class="row">
                                <div class="col-md-5 border-end">
                                    <div class="info-card">
                                        <strong class="d-block" id="designBriefTitle">--</strong>
                                        <span class="badge bg-secondary" id="designNetwork">--</span>
                                        <span class="badge bg-light text-dark border" id="designDate">--</span>
                                        <div class="mt-2 text-muted small" id="designBriefText">...</div>
                                        <hr>
                                        <label class="small fw-bold">Headline</label>
                                        <div class="small fst-italic" id="designHeadline">...</div>
                                        <label class="small fw-bold mt-2">Legenda</label>
                                        <div class="small" id="designCaption">...</div>
                                    </div>
                                </div>
                                <div class="col-md-7 ps-4">
                                    <h6 class="fw-bold mb-3">Upload do Design</h6>
                                    <div class="upload-zone" onclick="document.getElementById('finalArtInput').click()" style="min-height: 300px;">
                                        <input type="file" id="finalArtInput" name="final_art" accept="image/*" style="display:none" onchange="previewUpload(this)">
                                        <img id="designPreviewImg" class="preview" style="display:none; max-width: 100%;">
                                        <div id="designUploadPlaceholder" class="text-center">
                                            <i class="fa-solid fa-cloud-arrow-up fs-1 text-muted"></i>
                                            <p class="mt-2 text-muted">Clique para enviar a arte</p>
                                        </div>
                                    </div>
                                    <div class="d-grid mt-3">
                                        <button type="button" class="btn btn-primary" onclick="saveAndAdvance('review_internal')">Salvar Design</button>
                                    </div>
                                </div>
                             </div>
                        </div>

                        <div class="tab-pane fade" id="tab-approval">
                             <div class="row">
                                <div class="col-md-6 d-flex justify-content-center">
                                    <div class="phone-frame" style="transform: scale(0.9); transform-origin: top center;">
                                        <div class="phone-screen bg-black d-flex align-items-center justify-content-center position-relative">
                                            <img id="approvalImage" src="" style="max-width: 100%; max-height: 100%; object-fit: contain;">
                                            <canvas id="annotationCanvas" style="position: absolute; top:0; left:0; width:100%; height:100%;"></canvas>
                                        </div>
                                    </div>
                                    <div id="drawControls" style="display:none; position: absolute; bottom: 10px;">
                                        <button type="button" class="btn btn-sm btn-danger" onclick="clearCanvas()">Limpar</button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h5 id="apprTitle">Título</h5>
                                    <small id="apprClient">Cliente</small> | <span id="apprNetwork">Rede</span>
                                    <div class="my-2"><i class="fa-regular fa-clock"></i> <span id="apprDate">Data</span></div>
                                    
                                    <div class="card p-2 bg-light mb-3">
                                        <small class="fw-bold">Legenda</small>
                                        <p class="small mb-0" id="apprCaption">...</p>
                                    </div>
                                    
                                    <img id="apprThumb" src="" style="display:none;">
                                    <input type="date" id="apprDateInput" class="d-none">

                                    <div class="d-grid gap-2" id="mainActions">
                                        <button type="button" class="btn btn-success" onclick="saveAndAdvance()">Aprovar / Salvar</button>
                                        <button type="button" class="btn btn-outline-danger" onclick="toggleRejectMode()">Solicitar Ajuste</button>
                                    </div>
                                    
                                    <div id="rejectPanel" class="card border-danger mt-3" style="display:none;">
                                        <div class="card-body p-2">
                                            <textarea id="feedbackInput" class="form-control mb-2" rows="2" placeholder="Motivo do ajuste..."></textarea>
                                            <button type="button" class="btn btn-danger w-100" onclick="saveWithAnnotation()">Confirmar</button>
                                        </div>
                                    </div>
                                </div>
                             </div>
                        </div>

                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    // Inicialização manual das Abas (Caso Bootstrap não carregue automático)
    document.addEventListener("DOMContentLoaded", function () {
        var triggerTabList = [].slice.call(document.querySelectorAll('#taskTabs button'))
        triggerTabList.forEach(function (triggerEl) {
            var tabTrigger = new bootstrap.Tab(triggerEl)
            triggerEl.addEventListener('click', function (event) {
                event.preventDefault()
                tabTrigger.show()
            })
        })
    });
</script>

<script>
    // JSON DO DJANGO (Crucial para as redes)
    window.CLIENT_NETWORKS = {{ client_networks_json | safe }};

    // Configurações Globais
    window.KANBAN_CONFIG = {
        urls: {
            addTask: "{% url 'add_operational_task' %}",
            taskDetails: "/api/task/details/",
            taskUpdate: "/task/update/"
        },
        csrfToken: "{{ csrf_token }}"
    };
</script>

<script src="{% static 'js/kanban_operational.js' %}"></script>
{% endblock %}
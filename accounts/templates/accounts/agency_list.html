{% extends "projects/base.html" %}
{% load static %}

{% block title %}Gestão de Agências{% endblock %}

{% block content %}
<style>
    .color-dot { width: 20px; height: 20px; border-radius: 50%; display: inline-block; border: 1px solid #ddd; margin-right: 5px; }
    .agency-logo-thumb { width: 40px; height: 40px; object-fit: contain; background: #f8f9fa; border-radius: 6px; padding: 2px; border: 1px solid #eee; }
    .nav-tabs .nav-link { color: #666; cursor: pointer; }
    .nav-tabs .nav-link.active { font-weight: bold; color: var(--primary-color); }
    .tab-content { padding: 20px 0; }
</style>

<div class="page-container">
    <div class="header-wrapper">
        <div>
            <h1 class="page-title">Agências (Tenants)</h1>
            <p class="page-subtitle">Gerencie os ambientes e domínios.</p>
        </div>
        <button onclick="openCreateModal()" class="btn btn-primary">
            <i class="fa-solid fa-plus"></i> Nova Agência
        </button>
    </div>

    <div class="card" style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
        <table class="table table-hover align-middle">
            <thead>
                <tr>
                    <th width="80">Logo</th>
                    <th>Agência</th>
                    <th>Domínio</th>
                    <th>Cores</th>
                    <th>Status</th>
                    <th>Contrato</th>
                    <th class="text-end">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for agency in agencies %}
                <tr>
                    <td>
                        {% if agency.logo %}
                            <img src="{{ agency.logo.url }}" class="agency-logo-thumb">
                        {% else %}
                            <div class="agency-logo-thumb d-flex align-items-center justify-content-center text-muted"><i class="fa-solid fa-image"></i></div>
                        {% endif %}
                    </td>
                    <td>
                        <div style="font-weight: 600;">{{ agency.name }}</div>
                        <code style="font-size: 0.8em; color: #888;">{{ agency.schema_name }}</code>
                    </td>
                    <td>
                        <a href="http://{{ agency.domains.first.domain }}" target="_blank" class="text-decoration-none">
                            {{ agency.domains.first.domain }}
                        </a>
                    </td>
                    <td>
                        <div class="color-dot" style="background-color: {{ agency.primary_color }};" title="Primária"></div>
                        <div class="color-dot" style="background-color: {{ agency.secondary_color }};" title="Secundária"></div>
                    </td>
                    <td>
                        {% if agency.on_trial %}<span class="badge bg-warning text-dark">Trial</span>{% else %}<span class="badge bg-success">Ativo</span>{% endif %}
                    </td>
                    <td>
                        {{ agency.paid_until|date:"d/m/Y"|default:"-" }}
                    </td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-secondary" 
                            onclick="editAgency(
                                '{% url "update_agency" agency.id %}', 
                                '{{ agency.name|escapejs }}',
                                '{{ agency.schema_name }}',
                                '{{ agency.domains.first.domain }}',
                                '{{ agency.primary_color }}',
                                '{{ agency.secondary_color }}',
                                '{{ agency.on_trial|yesno:'true,false' }}',
                                '{{ agency.paid_until|date:'Y-m-d' }}',
                                {{ agency.menu_config.allowed_modules|default:'[]'|safe }}
                            )">
                            <i class="fa-solid fa-pen"></i>
                        </button>
                        
                        <button class="btn btn-sm btn-outline-danger" 
                            onclick="deleteAgency('{% url 'delete_agency' agency.id %}', '{{ agency.name|escapejs }}')">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="7" class="text-center py-5">Nenhuma agência encontrada.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div id="modal-new-agency" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 800px; padding: 0;">
        <div style="padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0; font-size: 1.5rem;" id="modal-title">Cadastrar Agência</h2>
            <span class="close-button" onclick="closeModal()" style="cursor: pointer;">&times;</span>
        </div>

        <form method="POST" id="agency-form" action="{% url 'create_agency' %}" enctype="multipart/form-data" onsubmit="showLoading()" style="padding: 20px;">
            {% csrf_token %}
            <ul class="nav nav-tabs" id="agencyTab" role="tablist">
                <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" data-bs-target="#dados">Dados Gerais</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" data-bs-target="#branding">Personalização</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" data-bs-target="#contrato">Contrato</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" data-bs-target="#modulos">Módulos</a></li>
            </ul>

            <div class="tab-content" id="agencyTabContent">
                <div class="tab-pane fade show active" id="dados">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="fw-bold">Nome</label>
                            <input type="text" name="name" id="input-name" class="form-control" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="fw-bold">Schema</label>
                            <input type="text" name="schema_name" id="input-schema" class="form-control" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="fw-bold">Domínio</label>
                        <input type="text" name="domain_url" id="input-domain" class="form-control" required>
                    </div>
                </div>

                <div class="tab-pane fade" id="branding">
                    <div class="mb-3">
                        <label>Logo</label>
                        <input type="file" name="logo" class="form-control">
                    </div>
                    <div class="row">
                        <div class="col-6"><label>Cor Primária</label><input type="color" name="primary_color" id="input-primary" class="form-control form-control-color"></div>
                        <div class="col-6"><label>Cor Secundária</label><input type="color" name="secondary_color" id="input-secondary" class="form-control form-control-color"></div>
                    </div>
                </div>

                <div class="tab-pane fade" id="contrato">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" name="on_trial" id="input-trial" onchange="togglePaidDate()">
                        <label class="form-check-label" for="input-trial">Trial?</label>
                    </div>
                    <div id="paid_date_container">
                        <label>Pago Até</label>
                        <input type="date" name="paid_until" id="input-paid" class="form-control">
                    </div>
                </div>

                <div class="tab-pane fade" id="modulos">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <label class="card p-2"><input type="checkbox" name="visible_menus" value="gestao" class="mod-check"> Gestão</label>
                        <label class="card p-2"><input type="checkbox" name="visible_menus" value="producao" class="mod-check"> Produção</label>
                        <label class="card p-2"><input type="checkbox" name="visible_menus" value="social" class="mod-check"> Social</label>
                        <label class="card p-2"><input type="checkbox" name="visible_menus" value="arquivos" class="mod-check"> Arquivos</label>
                        <label class="card p-2"><input type="checkbox" name="visible_menus" value="admin" class="mod-check"> Admin</label>
                    </div>
                </div>
            </div>

            <div class="mt-3 text-end">
                <button type="button" class="btn btn-secondary me-2" onclick="closeModal()">Cancelar</button>
                <button type="submit" class="btn btn-primary" id="btn-submit">Salvar</button>
            </div>
        </form>
    </div>
</div>

<form id="delete-form" method="POST" style="display: none;">
    {% csrf_token %}
</form>

<script>
    // URLs base geradas pelo Django para serem usadas no JS
    const URL_CREATE = "{% url 'create_agency' %}";
    // Truque para URL de update com ID 0 que será substituído
    const URL_UPDATE_BASE = "{% url 'update_agency' 0 %}".replace('0/', ''); 

    function closeModal() {
        document.getElementById('modal-new-agency').style.display = 'none';
    }

    function togglePaidDate() {
        const isTrial = document.getElementById('input-trial').checked;
        document.getElementById('paid_date_container').style.display = isTrial ? 'none' : 'block';
    }

    // --- FUNÇÃO 1: Abrir Modal Limpo (Criar) ---
    function openCreateModal() {
        const form = document.getElementById('agency-form');
        form.reset(); // Limpa inputs
        form.action = URL_CREATE; // Aponta para view de criação
        
        document.getElementById('modal-title').innerText = "Cadastrar Nova Agência";
        document.getElementById('btn-submit').innerText = "Criar Agência";
        document.getElementById('input-schema').readOnly = false; // Schema pode ser editado na criação
        
        // Reseta visibilidade da data
        togglePaidDate();
        
        document.getElementById('modal-new-agency').style.display = 'flex';
    }

    // --- FUNÇÃO 2: Abrir Modal Preenchido (Editar) ---
    // Note que o primeiro parâmetro agora se chama 'actionUrl' em vez de 'id'
function editAgency(actionUrl, name, schema, domain, primary, secondary, isTrial, paidDate, modules) {
    const form = document.getElementById('agency-form');
    
    // CORREÇÃO: Usamos a URL que veio pronta do Django, sem somar strings
    form.action = actionUrl;

    // 2. Muda textos visuais
    document.getElementById('modal-title').innerText = "Editar Agência: " + name;
    document.getElementById('btn-submit').innerText = "Salvar Alterações";

    // 3. Preenche os inputs simples
    document.getElementById('input-name').value = name;
    document.getElementById('input-schema').value = schema;
    document.getElementById('input-schema').readOnly = true; 
    document.getElementById('input-domain').value = domain;
    document.getElementById('input-primary').value = primary;
    document.getElementById('input-secondary').value = secondary;
    
    // 4. Checkbox Trial e Data
    // Conversão segura de string 'true'/'false' ou booleano
    const isTrialBool = (isTrial === 'true' || isTrial === true || isTrial === 'True');
    document.getElementById('input-trial').checked = isTrialBool;
    
    document.getElementById('input-paid').value = paidDate && paidDate !== 'None' ? paidDate : '';
    togglePaidDate(); 

    // 5. Preenche os Módulos
    document.querySelectorAll('.mod-check').forEach(chk => chk.checked = false);
    
    if (modules && Array.isArray(modules)) {
        modules.forEach(mod => {
            const checkbox = document.querySelector(`.mod-check[value="${mod}"]`);
            if (checkbox) checkbox.checked = true;
        });
    }

    document.getElementById('modal-new-agency').style.display = 'flex';
}

function showLoading() {
    document.getElementById('modal-new-agency').style.display = 'none';
    Swal.fire({
        title: 'Processando...',
        text: 'Por favor, aguarde.',
        allowOutsideClick: false,
        didOpen: () => { Swal.showLoading() }
    });
}
function deleteAgency(deleteUrl, agencyName) {
    Swal.fire({
        title: `Excluir Agência: ${agencyName}?`,
        text: "Esta ação é irreversível!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sim, excluir!',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            const form = document.getElementById('delete-form');
            form.action = deleteUrl;
            form.submit();
        }
    });
}
</script>
{% endblock %}